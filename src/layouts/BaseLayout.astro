---
import { Footer, Header, ThemeProvider } from 'astro-pure/components/basic'
import type { SiteMeta } from 'astro-pure/types'
import BaseHead from '@/components/BaseHead.astro'
import config from '@/site-config'

// Import the global.css file here so that it is included on
// all pages through the use of the <BaseLayout /> component.
import 'katex/dist/katex.min.css'
import '@/assets/styles/global.css'
import '@/assets/styles/app.css'

interface Props {
  meta: SiteMeta
  highlightColor?: string
}

const {
  meta: { articleDate, description = config.description, ogImage, title },
  highlightColor,
  ...props
} = Astro.props
---

<html lang={config.locale.lang}>
  <head>
    <BaseHead {articleDate} {description} {ogImage} {title} />

    <script is:inline>
    (function() {
      // è·å– URL é‡Œçš„ sync_theme å‚æ•°
      const params = new URLSearchParams(window.location.search);
      const theme = params.get('sync_theme');
      
      if (theme) {
        // 1. å¼ºåˆ¶å†™å…¥æœ¬åœ°å­˜å‚¨ï¼Œè¿™æ ·æŒ‰é’®åˆå§‹åŒ–æ—¶å°±èƒ½è¯»åˆ°æ­£ç¡®çš„å€¼
        localStorage.setItem('theme', theme);
        
        // 2. ç«‹å³åº”ç”¨åˆ°ç½‘é¡µï¼Œé˜²æ­¢é—ªçƒ
        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.classList.remove('dark');
          document.documentElement.setAttribute('data-theme', 'light');
        }
        
        // 3. (å…³é”®) æ´¾å‘ä¸€ä¸ªäº‹ä»¶ï¼Œé€šçŸ¥é‚£ä¸ªæŒ‰é’®ç»„ä»¶â€œä¸»é¢˜å˜äº†ï¼Œå¿«åˆ·æ–°å›¾æ ‡â€
        // å¾ˆå¤š Astro ä¸»é¢˜éƒ½ç›‘å¬è¿™ä¸ªäº‹ä»¶
        document.dispatchEvent(new CustomEvent('theme-change', { detail: { theme } }));
      }
    })();
  </script>
  <ThemeProvider />
</head>

  <body class='flex justify-center bg-background text-foreground' {...props}>
    {
      highlightColor && (
        <div
          id='highlight-gradient'
          class='pointer-events-none absolute start-0 top-0 z-0 h-screen w-full opacity-25'
          style={`background-image:linear-gradient(${highlightColor},transparent)`}
        />
      )
    }
    <div
      class='w-full max-w-[70rem] px-4 sm:px-7 lg:px-10 min-h-[100dvh] flex flex-col justify-between'
    >
      <Header />
      <div class='flex-1 w-full'>
        <slot />
      </div>
      <Footer />
    </div>

    {/* Set highlight color */}
    <style define:vars={{ highlightColor }}>
      :global(.highlight) {
        --highlight-fg: color-mix(
          in srgb,
          var(--highlightColor) 40%,
          hsl(var(--foreground)/var(--un-text-opacity, 1))
        );
        color: var(--highlight-fg, hsl(var(--primary) / var(--un-text-opacity))) !important;
      }
      :global(.highlight-bg) {
        background-color: var(
          --highlightColor,
          hsl(var(--primary) / var(--un-text-opacity))
        ) !important;
      }
    </style>
<script is:inline>
    // ===========================================
    // ğŸŸ¢ è¿™é‡Œå¡«å†™ç›®æ ‡åŸŸå (ä¸è¦å¸¦æœ«å°¾çš„æ–œæ  /)
    const targetDomain = 'https://en.maxtonniu.com/'; 
    // ===========================================

    document.addEventListener('DOMContentLoaded', () => {
      const langBtn = document.querySelector('a[href="#switch-lang"]');
      
      if (langBtn) {
        // 1. è·å–å½“å‰è·¯å¾„ï¼Œç¡®ä¿æ˜¯ / å¼€å¤´çš„
        let currentPath = window.location.pathname;
        if (!currentPath.startsWith('/')) {
            currentPath = '/' + currentPath;
        }

        // 2. è·å–å½“å‰ä¸»é¢˜ (é»˜è®¤ä¸º light)
        const currentTheme = localStorage.getItem('theme') || 'light';
        
        // 3. æ‹¼æ¥å®Œæ•´ URL
        // é€»è¾‘ï¼šç›®æ ‡åŸŸå + å½“å‰è·¯å¾„ + ä¸»é¢˜å‚æ•°
        // è§£å†³ 404 çš„å…³é”®ï¼šç¡®ä¿ targetDomain æ²¡æ–œæ ï¼ŒcurrentPath æœ‰æ–œæ 
        const cleanDomain = targetDomain.replace(/\/$/, ''); // å»æ‰åŸŸåæœ«å°¾å¤šä½™æ–œæ 
        const finalUrl = `${cleanDomain}${currentPath}?sync_theme=${currentTheme}`;

        // 4. åº”ç”¨é“¾æ¥
        langBtn.href = finalUrl;

        // 5. é¼ æ ‡æ”¾ä¸Šå»æ—¶å†æ¬¡åˆ·æ–° (ç¡®ä¿ä¸»é¢˜çŠ¶æ€æ˜¯æœ€æ–°çš„)
        langBtn.addEventListener('mouseenter', () => {
           const latestTheme = localStorage.getItem('theme') || 'light';
           langBtn.href = `${cleanDomain}${currentPath}?sync_theme=${latestTheme}`;
        });
      }
    });
  </script>
  </body>

